---
import Layout from '../layouts/Layout.astro';
import { getEntry } from '../utils/craftApi';
import { HOME_PAGE_QUERY } from '../utils/queries';
import { journalEntries, journalLinks } from '../utils/data';
import LastFMTrack from '../components/LastFMTrack.astro';
import Image from '../components/CloudImage.astro';
import PostArticle from '../components/PostArticle.astro';
import LinkArticle from '../components/LinkArticle.astro';
import NowReading from '../components/NowReading.astro';

const homeData = await getEntry(HOME_PAGE_QUERY);
const latestJournalEntries = journalEntries.slice(0, 3);
const latestJournalLinks = journalLinks.slice(0, 3);
---

<Layout title="Matt Soria | photography + web development" bodyClass="">
	<div class="px-site-gutter">
		<div class="bento-box">
			<div class="personal-meta">
				<div class="site-intro card noisy-border">
					<div class="prose-container">
						{ homeData.note && <div class="rich-text" set:html={homeData.note} /> }
					</div>
				</div>
				{ homeData.portrait && (
					<div class="site-portrait noisy-border">
						<figure>
							<Image
								url={homeData.portrait[0].url}
								width={homeData.portrait[0].width}
								height={homeData.portrait[0].height}
							/>
							{homeData.portrait[0].captionSimple && (
								<figcaption class="pill">{homeData.portrait[0].captionSimple}</figcaption>
							)}
						</figure>
					</div>
				)}
				<div class="media">
					<div class="recent-track">
						<LastFMTrack />
					</div>
					{homeData.nowReading && (
						<div class="now-reading">
							<NowReading book={homeData.nowReading} />
						</div>
					)}
				</div>
			</div>
			<div class="latest-entries-container">
				{ latestJournalEntries && (
					<div class="latest-entries latest-journal-entries">
						<header>
							<h2 class="text-h2">Recent Journal Entries</h2>
							<a href="/journal" class="pill">View all <span class="visually-hidden">journal entries.</span></a>
						</header>
						<div class="latest-journal-entry-content">
							{ latestJournalEntries.map((post) =>
								<PostArticle post={post} first={false} />
							)}
						</div>
					</div>
				)}
				{ latestJournalLinks && (
					<div class="latest-entries latest-links">
						<header>
							<h2 class="text-h2">Recent Links</h2>
							<a href="/links" class="pill">View all <span class="visually-hidden">links.</span></a>
						</header>
						<ol class="links-list" role="list">
							{ latestJournalLinks.map((post) =>
								<li>
									<LinkArticle post={post} first={false} includeNote={false} />
								</li>
							)}
						</ol>
					</div>
				)}
			</div>
		</div>
	</div>
</Layout>

<style scoped>
	.bento-box {
		display: flex;
		flex-wrap: wrap;
		gap: var(--spacing-l);
		align-items: flex-start;
		
		> * {
			flex-grow: 1;
		}
		
		@media screen and (min-width: 1024px) {
			display: grid;
			grid-template-columns: repeat(2, minmax(0, 1fr));
		}
	}

	.personal-meta {
		display: grid;
		align-items: start;
		gap: var(--spacing-l);
		grid-template-columns: minmax(0, 1fr) minmax(200px, 1.5fr);
		grid-template-areas: 
			"intro intro"
			"portrait media";
	}

	.site-intro {
		grid-area: intro;
	}

	.site-portrait {
		position: relative;

		figure {
			width: 100%;
			overflow: hidden;
			border-radius: 2em;
			position: relative;
			corner-shape: squircle;

			&:hover {
				figcaption {
					opacity: 1;
				}
			}
		}

		figcaption {
			--color-pill-background: var(--color-background);
			z-index: 1;
			opacity: 0;
			position: absolute;
			display: inline-block;
			transition: opacity 0.2s ease-out;
			inset-block-end: var(--spacing-2xs);
			inset-inline-start: var(--spacing-2xs);
		}
	}

	.media {
		display: flex;
		gap: var(--spacing-l);
		flex-direction: column;
	}

	.latest-entries-container {
		display: flex;
		gap: var(--spacing-l);
		flex-direction: column;
	}

	.latest-entries {
		display: flex;
		gap: var(--spacing-2xs);
		flex-direction: column;

		header {
			display: flex;
			gap: var(--spacing-s);
			align-items: baseline;
			justify-content: space-between;
		}

		li {
			width: 100%;
		}
	}
</style>